<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeerJS PC Stream - Make your hardware better</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PeerJS CDN -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <!-- Bootstrap for quick styles (optional, for layout) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #181c21;
      color: #fafbfc;
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      margin: 0; padding: 0;
    }
    header {
      background: #23272f;
      padding: 2rem 0 1rem 0;
      text-align: center;
      box-shadow: 0 2px 8px #000a;
    }
    h1 {
      color: #00eaff;
      font-size: 2.3rem;
      margin-bottom: 0.3em;
    }
    .tagline {
      color: #a0f2e3;
      font-size: 1.2em;
      margin-bottom: 0.3em;
    }
    #stream-container {
      margin: 2rem auto 1.5rem auto;
      max-width: 800px;
      background: #222b35;
      border-radius: 16px;
      box-shadow: 0 2px 16px #00eaff22;
      padding: 2rem 2rem 1.5rem 2rem;
      position: relative;
    }
    #display-stream {
      width: 100%;
      height: 400px;
      background: #11171d;
      border: 2px solid #00eaff;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #00eaff;
      position: relative;
      overflow: hidden;
    }
    #peer-list {
      background: #23272f;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      margin-top: 1.2rem;
      box-shadow: 0 2px 8px #00eaff11;
    }
    #peer-list h2 {
      color: #00eaff;
      font-size: 1.1em;
      margin-bottom: 0.5em;
    }
    .peer-item {
      margin-bottom: 0.5em;
      color: #a0f2e3;
      font-size: 1em;
    }
    .peer-ip {
      color: #a0d2ff;
      font-size: 0.95em;
      margin-left: 0.7em;
    }
    #your-peer-id {
      margin-bottom: 1.1em;
      color: #a0f2e3;
      font-size: 1.15em;
      word-break: break-all;
    }
    #status {
      color: #f7e24e;
      min-height: 20px;
      text-align: center;
      margin-bottom: 1em;
    }
    #webgl-canvas {
      display: none;
      /* Will be shown if being shared */
    }
    .gpu-info {
      font-size: 1em;
      color: #39ffc4;
      margin-top: 0.6em;
    }
    @media (max-width: 700px) {
      #stream-container { padding: 1rem 0.4rem; }
      #display-stream { height: 32vw; min-height: 160px; }
      #peer-list { padding: 0.7rem 0.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <h1>PeerJS PC Stream</h1>
    <div class="tagline">Make your hardware better</div>
    <div style="color:#b0c3d5;">
      Stream your PC by sharing hardware with peers globally.<br>
      Display changes in real-time if better hardware is streamed to you.<br>
      <span style="color:#39ffc4">Tip: Use the WebGL GPU trick to share GPU info or a live GPU-powered canvas.</span>
    </div>
  </header>
  <div id="stream-container" class="container">
    <div id="your-peer-id">Connecting...</div>
    <div id="status"></div>
    <div id="display-stream">
      Waiting for stream or screen share...
      <canvas id="webgl-canvas" width="640" height="400"></canvas>
    </div>
    <div class="d-flex gap-2 mb-2">
      <button id="start-share" class="btn btn-outline-info">Share My Screen</button>
      <button id="share-gpu" class="btn btn-outline-primary">Share WebGL (GPU)</button>
      <button id="stop-share" class="btn btn-outline-warning" disabled>Stop Sharing</button>
    </div>
    <div class="gpu-info" id="gpu-info"></div>
    <div id="peer-list">
      <h2>Connected Peers</h2>
      <div id="peer-list-content">No peers connected yet.</div>
    </div>
  </div>
  <script>
    // PeerJS init
    const peer = new Peer(undefined, {
      host: "peerjs.com",
      port: 443,
      path: "/",
      secure: true
    });

    let localStream = null;
    let connPeers = {};
    let connections = [];
    let displayStreamEl = null;
    let myPeerId = null;
    let myIp = null;
    let allowIp = false;

    // UI Elements
    const displayDiv = document.getElementById("display-stream");
    const peerIdDiv = document.getElementById("your-peer-id");
    const statusDiv = document.getElementById("status");
    const peerListDiv = document.getElementById("peer-list-content");
    const startBtn = document.getElementById("start-share");
    const shareGpuBtn = document.getElementById("share-gpu");
    const stopBtn = document.getElementById("stop-share");
    const canvas = document.getElementById("webgl-canvas");
    const gpuInfoDiv = document.getElementById("gpu-info");

    // Get WebGL GPU info
    function getWebGLInfo() {
      let gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (!gl) return { renderer: "Unavailable", vendor: "Unavailable" };
      let dbgRenderInfo = gl.getExtension('WEBGL_debug_renderer_info');
      let renderer = dbgRenderInfo ? gl.getParameter(dbgRenderInfo.UNMASKED_RENDERER_WEBGL) : "Unknown";
      let vendor = dbgRenderInfo ? gl.getParameter(dbgRenderInfo.UNMASKED_VENDOR_WEBGL) : "Unknown";
      return { renderer, vendor };
    }
    function showGpuInfoLocal() {
      const { renderer, vendor } = getWebGLInfo();
      gpuInfoDiv.textContent = `Your GPU: ${renderer} (${vendor})`;
    }
    function showGpuInfoRemote(gpuStr) {
      gpuInfoDiv.textContent = `Remote GPU: ${gpuStr}`;
    }

    // UI: toggle status
    function setStatus(msg) { statusDiv.textContent = msg; }

    // UI: update peer list
    function updatePeerList() {
      const ids = Object.keys(connPeers);
      if (ids.length === 0) {
        peerListDiv.textContent = "No peers connected yet.";
        return;
      }
      peerListDiv.innerHTML = "";
      ids.forEach(pid => {
        const peer = connPeers[pid];
        let ipinfo = "";
        if (peer && peer.ip) ipinfo = `<span class="peer-ip">(${peer.ip})</span>`;
        peerListDiv.innerHTML += `<div class="peer-item"><b>${pid}</b> ${ipinfo}</div>`;
      });
    }

    // UI: show stream in element
    function showStream(stream, owner = "You") {
      displayDiv.innerHTML = "";
      let video = document.createElement("video");
      video.srcObject = stream;
      video.autoplay = true;
      video.muted = (owner === "You");
      video.controls = true;
      video.style.width = "100%";
      video.style.height = "100%";
      displayDiv.appendChild(video);
      displayDiv.insertAdjacentHTML("beforeend", `<div style="color:#c0eaff;font-size:0.95em;position:absolute;bottom:7px;left:14px;">Stream owner: <b>${owner}</b></div>`);
      displayStreamEl = video;
    }

    // UI: show no stream
    function showNoStream(msg) {
      displayDiv.innerHTML = msg || "Waiting for stream or screen share...";
      displayStreamEl = null;
      gpuInfoDiv.textContent = '';
    }

    // Start/stop screen sharing
    startBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
        showStream(localStream, "You");
        startBtn.disabled = true;
        shareGpuBtn.disabled = true;
        stopBtn.disabled = false;
        broadcastStream();
      } catch (e) {
        setStatus("Screen share cancelled or error: " + e.message);
      }
    };

    // Share WebGL (GPU) canvas via screen share
    shareGpuBtn.onclick = async () => {
      // Show canvas and start animation (simulate GPU load)
      canvas.style.display = "block";
      startWebGLAnimation();
      try {
        localStream = canvas.captureStream(30);
        showStream(localStream, "You (WebGL)");
        startBtn.disabled = true;
        shareGpuBtn.disabled = true;
        stopBtn.disabled = false;
        broadcastStream();
        // Send GPU info to peers
        broadcastGpuInfo();
        showGpuInfoLocal();
      } catch (e) {
        setStatus("WebGL share error: " + e.message);
      }
    };

    // Stop sharing
    stopBtn.onclick = () => {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
        showNoStream("Stopped sharing. Waiting for stream...");
        startBtn.disabled = false;
        shareGpuBtn.disabled = false;
        stopBtn.disabled = true;
        canvas.style.display = "none";
        stopWebGLAnimation();
        gpuInfoDiv.textContent = "";
      }
    };

    // WebGL animation (demo: spinning cube)
    let gl, animId;
    function startWebGLAnimation() {
      gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (!gl) return;
      let t = 0;
      function draw() {
        t += 0.01;
        gl.clearColor(Math.abs(Math.sin(t)), Math.abs(Math.cos(t)), Math.abs(Math.sin(t/2)), 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);
        animId = requestAnimationFrame(draw);
      }
      draw();
    }
    function stopWebGLAnimation() {
      if (animId) cancelAnimationFrame(animId);
      if (gl) gl.clear(gl.COLOR_BUFFER_BIT);
    }

    // Get public IP if allowed
    function requestIp() {
      fetch("https://api.ipify.org/?format=json")
        .then(r => r.json())
        .then(d => { myIp = d.ip; updatePeerList(); });
    }

    // Ask if user wants to share their IP address for display
    function askIpSharing() {
      statusDiv.innerHTML = `
        <label>
          <input type="checkbox" id="allow-ip-checkbox">
          Allow peers to see your IP address (for display)
        </label>
      `;
      document.getElementById('allow-ip-checkbox').addEventListener('change', (e) => {
        allowIp = e.target.checked;
        if (allowIp && !myIp) requestIp();
        // Inform all peers
        Object.values(connPeers).forEach(peer => {
          if (peer.conn) peer.conn.send({type:"ip", ip: (allowIp ? myIp : null)});
        });
        updatePeerList();
      });
    }

    // Broadcast GPU info to peers
    function broadcastGpuInfo() {
      const { renderer, vendor } = getWebGLInfo();
      Object.values(connPeers).forEach(peer => {
        if (peer.conn) peer.conn.send({type: "gpu", gpu: `${renderer} (${vendor})`});
      });
    }

    // Broadcast local stream to all new calls
    function broadcastStream() {
      connections.forEach(call => {
        // No dynamic track replacement in PeerJS, so new call is needed for new stream
        // (Alternatively, use replaceTrack in WebRTC directly)
        // For now: disconnect and reconnect if needed
      });
    }

    // PeerJS events
    peer.on("open", id => {
      myPeerId = id;
      peerIdDiv.textContent = "Your Peer ID: " + id;
      askIpSharing();
      setStatus("Ready! Share your Peer ID to connect.");
      showGpuInfoLocal();
    });

    // Listen for incoming connections for screen stream
    peer.on("call", call => {
      if (localStream) {
        call.answer(localStream);
        setStatus("Sending your screen to a peer.");
      } else {
        // Try to receive remote stream
        call.answer();
        call.on("stream", stream => {
          showStream(stream, call.peer);
          setStatus("Receiving stream from peer: " + call.peer);
        });
      }
      connections.push(call);
    });

    // Listen for incoming data (IP info, GPU info, etc)
    peer.on("connection", conn => {
      conn.on("data", data => {
        if (data.type === "ip" && data.ip) {
          if (!connPeers[conn.peer]) connPeers[conn.peer] = {};
          connPeers[conn.peer].ip = data.ip;
          updatePeerList();
        }
        if (data.type === "gpu" && data.gpu) {
          showGpuInfoRemote(data.gpu);
        }
      });
      connPeers[conn.peer] = {conn};
      updatePeerList();
    });

    // Connect to another peer by prompt
    function connectToPeerDialog() {
      const dest = prompt("Enter the Peer ID to connect to:");
      if (dest && dest !== myPeerId) {
        // Data connection for IP, GPU info sharing
        const conn = peer.connect(dest);
        conn.on("open", () => {
          connPeers[dest] = {conn};
          if (allowIp && myIp) conn.send({type:"ip", ip:myIp});
          // On connect, send our GPU info
          const { renderer, vendor } = getWebGLInfo();
          conn.send({type: "gpu", gpu: `${renderer} (${vendor})`});
          updatePeerList();
        });
        conn.on("data", data => {
          if (data.type === "ip" && data.ip) {
            if (!connPeers[dest]) connPeers[dest] = {};
            connPeers[dest].ip = data.ip;
            updatePeerList();
          }
          if (data.type === "gpu" && data.gpu) {
            showGpuInfoRemote(data.gpu);
          }
        });
        // Media connection for stream
        const call = peer.call(dest, localStream || undefined);
        call.on("stream", stream => {
          showStream(stream, dest);
          setStatus("Receiving stream from peer: " + dest);
        });
        connections.push(call);
      }
    }

    // Add connect button
    const connectBtn = document.createElement("button");
    connectBtn.className = "btn btn-outline-success";
    connectBtn.textContent = "Connect to Peer";
    connectBtn.onclick = connectToPeerDialog;
    document.getElementById("stream-container").prepend(connectBtn);

    // Try to auto-connect by hash
    window.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.replace("#","");
      if (hash && hash.length > 10) {
        // Auto-connect if PeerID in hash
        setTimeout(() => {
          connectToPeerDialog(hash);
        }, 1500);
      }
    });

    // Initial
    showNoStream();
    updatePeerList();
    showGpuInfoLocal();
  </script>
</body>
</html>
